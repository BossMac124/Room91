<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>통합 지도 검색</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d6d23793f0ca98625a72a1157e4c9fe7&libraries=services"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<h2>📍 주소 또는 키워드로 검색</h2>
<input type="text" id="input" placeholder="주소나 키워드를 입력하세요">
<button onclick="search()">검색</button>

<div id="result" style="margin-top: 10px;"></div>
<div id="map"></div>

<script>
    let map;
    let geocoder;
    let marker; // 주소 검색 마커
    let placeMarkers = []; // 키워드 검색 마커들

    function initMap() {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
        };
        map = new kakao.maps.Map(container, options);
        geocoder = new kakao.maps.services.Geocoder();
    }

    function search() {
        const input = document.getElementById("input").value.trim();
        const resultDiv = document.getElementById("result");

        if (!input) {
            alert("검색어를 입력하세요!");
            return;
        }

        // 1. 주소 검색 먼저 시도
        geocoder.addressSearch(input, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const lat = result[0].y;
                const lng = result[0].x;

                resultDiv.innerHTML = `<p>📍 주소로 검색됨<br>위도: ${lat}, 경도: ${lng}</p>`;
                const moveLatLng = new kakao.maps.LatLng(lat, lng);
                map.setCenter(moveLatLng);

                // 기존 마커 제거
                if (marker) marker.setMap(null);
                placeMarkers.forEach(m => m.setMap(null));
                placeMarkers = [];

                // 새 마커 추가
                marker = new kakao.maps.Marker({
                    map: map,
                    position: moveLatLng,
                    title: input
                });

            } else {
                // 2. 주소 검색 실패 → 키워드 검색으로 fallback
                const ps = new kakao.maps.services.Places();

                // 기존 마커 제거
                if (marker) marker.setMap(null);
                placeMarkers.forEach(m => m.setMap(null));
                placeMarkers = [];

                ps.keywordSearch(input, function (data, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const bounds = new kakao.maps.LatLngBounds();
                        data.forEach(place => {
                            const position = new kakao.maps.LatLng(place.y, place.x);
                            const keywordMarker = new kakao.maps.Marker({
                                map: map,
                                position: position,
                                title: place.place_name
                            });
                            placeMarkers.push(keywordMarker);
                            bounds.extend(position);
                        });
                        map.setBounds(bounds);
                        resultDiv.innerHTML = `🔍 <b>${input}</b> 키워드로 ${data.length}개 결과 표시됨`;
                    } else {
                        resultDiv.innerHTML = "❌ 검색 결과가 없습니다.";
                    }
                });
            }
        });
    }

    window.onload = initMap;
</script>
</body>
</html>
