<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>투룸 매물 지도</title>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c0621bc4a0f59aff38dbd93a18f3ec6f&libraries=services,clusterer"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif }
        nav {
            background: #007aff; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        nav button {
            border: none; border-radius: 4px; padding: 6px 12px; font-size: 14px; cursor: pointer;
        }
        nav button.active {
            background: #005fcc; color: white;
        }
        nav button.inactive {
            background: white; color: #007aff;
        }
        #mainLayout { display: flex; flex: 1; }
        #houseList { width: 300px; border-right: 1px solid #ccc; padding: 10px; background: #fafafa; overflow-y: auto }
        #directionBtn { width: 100%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 4px; background: #007aff; color: #fff; font-size: 16px; cursor: pointer }
        #directionResult { border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 10px; background: #fff }
        #houseListContent .house-item { padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; background: #fff; cursor: pointer }
        #houseListContent .house-item:hover { background: #f0f0f0 }
        .house-title { font-weight: bold; margin-bottom: 5px }
        .house-info { font-size: 14px; color: #666 }
        #houseDetail { width: 400px; border-right: 1px solid #ccc; padding: 10px; background: #fff; display: none; overflow-y: auto }
        #detailHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px }
        #detailHeader h3 { margin: 0; font-size: 18px }
        #closeDetailBtn { background: none; border: none; font-size: 18px; cursor: pointer; color: #999 }
        #closeDetailBtn:hover { color: #333 }
        .detail-row { margin-bottom: 6px }
        .detail-label { font-weight: bold; margin-right: 5px }
        #mapWrapper { flex: 1; position: relative }
        #map { width: 100%; height: 100% }
        #searchForm { position: absolute; top: 10px; left: 10px; z-index: 2; background: #fff; padding: 10px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,.3) }
    </style>
</head>
<body>

<!-- ✅ 네비게이션 바 -->
<nav>
    <div style="font-size: 18px; font-weight: bold;">🏠 부동산 매물 지도</div>
    <div>
        <button class="inactive" onclick="window.location.href='/'">원룸</button>
        <button class="active" disabled>투룸</button>
    </div>
</nav>

<!-- ✅ 메인 레이아웃 -->
<div id="mainLayout">
    <!-- 매물 목록 -->
    <div id="houseList">
        <button id="directionBtn">길찾기</button>
        <div id="directionResult">여기에 길찾기 결과가 표시됩니다.</div>
        <div id="houseListContent"><p>투룸 매물 목록이 여기 표시됩니다.</p></div>
    </div>

    <!-- 매물 상세 -->
    <div id="houseDetail">
        <div id="detailHeader"><h3>매물 상세 정보</h3><button id="closeDetailBtn">X</button></div>
        <div id="detailContent"><p>매물을 클릭하면 상세 정보가 표시됩니다.</p></div>
    </div>

    <!-- 지도 -->
    <div id="mapWrapper">
        <div id="searchForm">
            <div style="margin-bottom:5px">
                <label><input type="checkbox" name="tradeType" value="B1" checked> 전세</label>
                <label><input type="checkbox" name="tradeType" value="B2" checked> 월세</label>
                <label><input type="checkbox" name="tradeType" value="B3" checked> 단기임대</label>
            </div>
            <div style="margin-bottom:5px">
                <label><b>월세 범위 (만원)</b></label><br/>
                <input id="rentPrcMin" type="number" placeholder="최소" style="width:60px"/> ~
                <input id="rentPrcMax" type="number" placeholder="최대" style="width:60px"/>
            </div>
            <div style="margin-bottom:5px">
                <label><b>보증금 범위 (만원)</b></label><br/>
                <input id="dealPrcMin" type="number" placeholder="최소" style="width:60px"/> ~
                <input id="dealPrcMax" type="number" placeholder="최대" style="width:60px"/>
            </div>
            <input id="addressInput" placeholder="주소를 입력하세요" style="width:200px"/>
            <button id="searchButton">검색</button>
        </div>
        <div id="map"></div>
    </div>
</div>

<script>
    let searchedLat = null, searchedLng = null;
    let destLat = null, destLng = null;
    let addressMarker = null, companyLabel = null;

    const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5665, 126.9780), level: 5
    });

    const clusterer = new kakao.maps.MarkerClusterer({
        map, averageCenter: true, minLevel: 2, minClusterSize: 1, calculator: [1]
    });

    document.getElementById('searchButton').onclick = () => {
        const addr = document.getElementById('addressInput').value.trim();
        if (!addr) {
            alert("주소를 입력하세요.");
            return;
        }

        const selectedTypes = Array.from(document.querySelectorAll('input[name="tradeType"]:checked'))
            .map(cb => cb.value);
        if (selectedTypes.length === 0) {
            alert("임대 유형을 하나 이상 선택하세요.");
            return;
        }

        const rentMin = document.getElementById('rentPrcMin').value.trim();
        const rentMax = document.getElementById('rentPrcMax').value.trim();
        const dealMin = document.getElementById('dealPrcMin').value.trim();
        const dealMax = document.getElementById('dealPrcMax').value.trim();

        const rentPrcMin = rentMin === "" ? 0 : parseInt(rentMin);
        const rentPrcMax = rentMax === "" ? 999999999 : parseInt(rentMax);
        const dealPrcMin = dealMin === "" ? 0 : parseInt(dealMin);
        const dealPrcMax = dealMax === "" ? 999999999 : parseInt(dealMax);

        new kakao.maps.services.Geocoder().addressSearch(addr, (res, stat) => {
            if (stat !== kakao.maps.services.Status.OK) {
                alert("주소 검색 결과가 없습니다.");
                return;
            }

            const lng = parseFloat(res[0].x), lat = parseFloat(res[0].y);
            searchedLat = lat; searchedLng = lng; destLat = destLng = null;
            map.setCenter(new kakao.maps.LatLng(lat, lng));

            if (addressMarker) addressMarker.setMap(null);
            if (companyLabel) companyLabel.setMap(null);

            addressMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lng),
                map
            });

            companyLabel = new kakao.maps.CustomOverlay({
                position: addressMarker.getPosition(), yAnchor: 1.4,
                content: `<div style="padding:4px 8px;background:#0066ff;color:#fff;
                          border-radius:4px;font-size:13px;white-space:nowrap">회사 위치</div>`
            });
            companyLabel.setMap(map);

            // ✅ 투룸 API 사용
            const typeParams = selectedTypes.map(t => `tradeTypeCodes=${t}`).join('&');
            const priceParams = `rentPrcMin=${rentPrcMin}&rentPrcMax=${rentPrcMax}&dealPrcMin=${dealPrcMin}&dealPrcMax=${dealPrcMax}`;
            const fullURL = `/house/two?lng=${lng}&lat=${lat}&radius=3&${typeParams}&${priceParams}`;

            fetch(fullURL)
                .then(r => r.json())
                .then(renderSearchResult)
                .catch(e => {
                    console.error(e);
                    alert("서버 호출 에러가 발생했습니다.");
                });
        });
    };

    function renderSearchResult(data) {
        clusterer.clear();
        const markers = data.map(h => {
            const [lng, lat] = h.location.coordinates;
            const m = new kakao.maps.Marker({position: new kakao.maps.LatLng(lat, lng)});
            m.houseData = h;
            const iw = new kakao.maps.InfoWindow({content:
                    `<div style="padding:5px;"><b>${h.buildingName || '건물명 미기재'}</b><br/>
       월세:${h.rentPrc || '-'}<br/>보증금:${h.dealOrWarrantPrc || '-'}</div>`});
            kakao.maps.event.addListener(m, 'mouseover', () => iw.open(map, m));
            kakao.maps.event.addListener(m, 'mouseout', () => iw.close());
            return m;
        });
        clusterer.addMarkers(markers);
        renderHouseList(data);
        closeDetailPanel();
        document.getElementById('directionResult').innerText = '여기에 길찾기 결과가 표시됩니다.';
    }

    kakao.maps.event.addListener(clusterer, 'clusterclick', c => {
        const houses = c.getMarkers().map(m => m.houseData);
        renderHouseList(houses);
        const cen = c.getCenter(); destLat = cen.getLat(); destLng = cen.getLng();
        closeDetailPanel();
        document.getElementById('directionResult').innerText = '여기에 길찾기 결과가 표시됩니다.';
    });

    document.getElementById('directionBtn').onclick = () => {
        if (!searchedLat || !searchedLng) {
            alert("먼저 주소 검색을 해주세요!");
            return;
        }
        if (!destLat || !destLng) {
            alert("목적지(매물)가 선택되지 않았습니다.");
            return;
        }
        fetch(`/house/direction?originLat=${searchedLat}&originLng=${searchedLng}&destLat=${destLat}&destLng=${destLng}`)
            .then(r => r.json())
            .then(d => {
                document.getElementById('directionResult').innerHTML =
                    `<h3>길찾기 결과 (도보 + 대중교통)</h3><p><b>이동거리:</b> ${d.distance}</p>
                     <p><b>소요시간:</b> ${d.duration}</p>`;
            })
            .catch(e => {
                console.error(e);
                alert("길찾기 API 호출 중 에러가 발생했습니다.");
            });
    };

    function renderHouseList(arr) {
        const list = document.getElementById('houseListContent');
        if (!arr.length) {
            list.innerHTML = '<p>매물이 없습니다.</p>';
            return;
        }
        list.innerHTML = arr.map((h, i) => `
    <div class="house-item" data-idx="${i}">
      <div class="house-title">${h.buildingName || '건물명 미기재'}</div>
      <div class="house-info">
        방타입:${h.articleName || '-'}<br/>월세:${h.rentPrc || '-'}<br/>
        보증금:${h.dealOrWarrantPrc || '-'}<br/>방향:${h.direction || '-'}</div>
    </div>`).join('');
        list.querySelectorAll('.house-item').forEach((el, i) => el.onclick = () => openDetailPanel(arr[i]));
    }

    const detailPanel = document.getElementById('houseDetail');
    const detailContent = document.getElementById('detailContent');
    document.getElementById('closeDetailBtn').onclick = closeDetailPanel;

    function openDetailPanel(house) {
        if (!house) return;
        const fields = [
            { label: '지역', value: house.region },
            { label: '방타입', value: house.articleName },
            { label: '지불 유형', value: house.tradeTypeName },
            { label: '건물이름', value: house.buildingName },
            { label: '매물 층', value: house.floorInfo },
            { label: '전체 면적', value: house.area1 },
            { label: '사용면적', value: house.area2 },
            { label: '경도', value: house.latitude },
            { label: '위도', value: house.longitude },
            { label: '방향', value: house.direction },
            { label: '등록 날짜', value: house.articleConfirmYmd },
            { label: '월세', value: house.rentPrc },
            { label: '태그', value: house.tagList },
            { label: '상세 설명', value: house.articleFeatureDesc },
            { label: '보증금', value: house.dealOrWarrantPrc },
            { label: '엘리베이터 수', value: house.elevatorCount },
            { label: '같은 매물 개수', value: house.sameAddrCnt },
            { label: '같은 매물 최소가격', value: house.sameAddrMinPrc },
            { label: '공인중개사', value: house.realtorName },
            { label: '매물등록사이트 ID', value: house.cpid },
            { label: '매물등록사이트 이름', value: house.cpName },
            { label: '매물등록사이트 URL', value: house.cpPcArticleUrl }
        ];
        detailContent.innerHTML = fields.map(f => `
    <div class="detail-row">
      <span class="detail-label">${f.label}:</span>
      <span>${(f.value !== null && f.value !== undefined) ? f.value : '-'}</span>
    </div>`).join('');
        detailPanel.style.display = 'block';
    }

    function closeDetailPanel() {
        detailPanel.style.display = 'none';
    }
</script>
</body>
</html>
